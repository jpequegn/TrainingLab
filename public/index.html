<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TrainingLab - Athlete Dashboard</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Main Styles -->
    <link rel="stylesheet" href="../styles/styles.css" />
    <!-- Navigation System Styles -->
    <link rel="stylesheet" href="../src/components/navigation/Navigation.css" />
    <link rel="stylesheet" href="../src/pages/BasePage.css" />
    <link rel="stylesheet" href="../src/pages/DashboardPage.css" />
    <link rel="stylesheet" href="../src/pages/VisualizerPage.css" />
    <link rel="stylesheet" href="../src/pages/ProfilePage.css" />
    <style>
      :root {
        /* Cycling-appropriate color scheme */
        --primary-blue: #2563eb;
        --secondary-blue: #1e40af;
        --accent-orange: #f97316;
        --success-green: #10b981;
        --warning-yellow: #f59e0b;
        --danger-red: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;

        /* Power zones */
        --zone1: #9ca3af;
        --zone2: #3b82f6;
        --zone3: #10b981;
        --zone4: #f59e0b;
        --zone5: #f97316;
        --zone6: #ef4444;
        --zone7: #7c3aed;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          'Inter',
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          system-ui,
          sans-serif;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        color: var(--gray-900);
        line-height: 1.6;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* Header */
      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--gray-200);
        padding: 1rem 0;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-blue);
      }

      .logo i {
        font-size: 2rem;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .profile-dropdown {
        position: relative;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(
          45deg,
          var(--primary-blue),
          var(--accent-orange)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .user-avatar:hover {
        transform: scale(1.05);
      }

      .profile-chevron {
        font-size: 0.75rem;
        margin-left: 0.25rem;
        transition: transform 0.2s ease;
      }

      .profile-dropdown.active .profile-chevron {
        transform: rotate(180deg);
      }

      .profile-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
        border: 1px solid var(--gray-200);
        min-width: 280px;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.2s ease;
      }

      .profile-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .profile-menu-header {
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .profile-menu-avatar {
        width: 48px;
        height: 48px;
        background: linear-gradient(
          45deg,
          var(--primary-blue),
          var(--accent-orange)
        );
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.125rem;
      }

      .profile-menu-info {
        flex: 1;
      }

      .profile-menu-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--gray-900);
        margin-bottom: 0.125rem;
      }

      .profile-menu-email {
        font-size: 0.75rem;
        color: var(--gray-600);
      }

      .profile-menu-divider {
        height: 1px;
        background: var(--gray-200);
        margin: 0.5rem 0;
      }

      .profile-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        color: var(--gray-700);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: background-color 0.2s ease;
      }

      .profile-menu-item:hover {
        background: var(--gray-100);
        color: var(--gray-900);
      }

      .profile-menu-item i {
        width: 16px;
        text-align: center;
        color: var(--gray-600);
      }

      /* Metrics Bar */
      .metrics-bar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 1.5rem 0;
        border-bottom: 1px solid var(--gray-200);
        position: sticky;
        top: 73px;
        z-index: 99;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
      }

      .metric-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        border: 1px solid var(--gray-200);
      }

      .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      }

      .metric-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }

      .metric-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: white;
      }

      .metric-title {
        font-size: 0.875rem;
        color: var(--gray-600);
        font-weight: 500;
      }

      .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
      }

      .metric-change {
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .metric-change.positive {
        color: var(--success-green);
      }

      .metric-change.negative {
        color: var(--danger-red);
      }

      .metric-change.neutral {
        color: var(--gray-600);
      }

      /* Main Content */
      .main-content {
        padding: 2rem 0;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 2px;
        margin-bottom: 2rem;
        background: white;
        border-radius: 12px;
        padding: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .tab-button {
        flex: 1;
        padding: 1rem 1.5rem;
        border: none;
        background: transparent;
        color: var(--gray-600);
        font-weight: 500;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .tab-button.active {
        background: var(--primary-blue);
        color: white;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
      }

      .tab-button:not(.active):hover {
        background: var(--gray-100);
        color: var(--gray-900);
      }

      /* Tab Content */
      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Athlete Tab */
      .athlete-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
      }

      .metrics-form {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        height: fit-content;
      }

      .form-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: var(--gray-900);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
      }

      .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: var(--primary-blue);
        color: white;
      }

      .btn-primary:hover {
        background: var(--secondary-blue);
      }

      .charts-container {
        display: grid;
        gap: 2rem;
      }

      .chart-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      }

      .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--gray-900);
      }

      .chart-placeholder {
        height: 250px;
        background: linear-gradient(
          135deg,
          var(--gray-100) 0%,
          var(--gray-200) 100%
        );
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-600);
        font-style: italic;
      }

      /* Training Tab */
      .training-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .filter-select {
        padding: 0.5rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 8px;
        background: white;
      }

      .sessions-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .sessions-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--gray-200);
        font-weight: 600;
        color: var(--gray-900);
      }

      .session-item {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--gray-200);
        display: grid;
        grid-template-columns: 120px 1fr 80px 80px 80px 80px 120px;
        gap: 1rem;
        align-items: center;
        transition: background 0.2s ease;
      }

      .session-item:hover {
        background: var(--gray-50);
      }

      .session-date {
        font-weight: 500;
        color: var(--gray-900);
      }

      .session-type {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .type-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 16px;
        font-size: 0.75rem;
        font-weight: 500;
        color: white;
      }

      .type-endurance {
        background: var(--zone2);
      }

      .type-threshold {
        background: var(--zone4);
      }

      .type-vo2max {
        background: var(--zone5);
      }

      .type-recovery {
        background: var(--zone1);
      }

      .integration-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .status-synced {
        background: var(--success-green);
      }

      .status-pending {
        background: var(--warning-yellow);
      }

      /* Performance Tab */
      .performance-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .power-curve {
        grid-column: 1 / -1;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .metrics-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 0.75rem;
        }

        .metric-card {
          padding: 1rem;
        }

        .metric-value {
          font-size: 1.5rem;
        }

        .tabs {
          flex-direction: column;
          gap: 1px;
        }

        .tab-button {
          padding: 1rem;
        }

        .athlete-grid {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .training-controls {
          flex-direction: column;
          align-items: stretch;
        }

        .session-item {
          grid-template-columns: 1fr;
          gap: 0.75rem;
          text-align: left;
        }

        .session-item > div {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .performance-grid {
          grid-template-columns: 1fr;
        }

        .metrics-bar {
          top: 57px;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 0 15px;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .metric-card {
          text-align: center;
        }

        .main-content {
          padding: 1.5rem 0;
        }

        .metrics-form,
        .chart-card,
        .sessions-container {
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Application Content -->
    <div id="app-content" class="app-content">
      <!-- Pages will be rendered here by the router -->
    </div>

    <!-- Screen reader announcements -->
    <div
      id="sr-announcements"
      aria-live="polite"
      aria-atomic="true"
      class="sr-only"
    ></div>

    <!-- Quick Settings Container (moved here for global access) -->
    <div id="quickSettingsContainer" style="display: none"></div>

    <!-- TrainingLab Navigation System -->
    <script type="module">
      // Import the new navigation system
      import { Router } from '../src/router/router.js';
      import { routes } from '../src/router/routes.js';
      import { routeGuardManager } from '../src/router/route-guards.js';
      import { Navigation } from '../src/components/navigation/Navigation.js';
      import { QuickSettings } from '../src/components/QuickSettings.js';

      // Import all pages
      import { DashboardPage } from '../src/pages/DashboardPage.js';
      import { VisualizerPage } from '../src/pages/VisualizerPage.js';
      import { ProfilePage } from '../src/pages/ProfilePage.js';
      import { LibraryPage } from '../src/pages/LibraryPage.js';
      import { HistoryPage } from '../src/pages/HistoryPage.js';

      // Global instances
      let router = null;
      let navigation = null;
      let quickSettings = null;

      // Initialize the application
      async function initializeApplication() {
        try {
          console.log('Initializing TrainingLab...');

          // Set up route components
          setupRouteComponents();

          // Initialize router
          router = new Router(routes);
          window.router = router; // Make globally accessible

          // Initialize navigation
          const navigationContainer = document.getElementById(
            'navigation-container'
          );
          navigation = new Navigation(navigationContainer, router);

          // Initialize quick settings
          initializeQuickSettings();

          // Setup route guards integration
          setupRouteGuards();

          // Start routing
          router.handleRouteChange();

          console.log('TrainingLab initialized successfully');
        } catch (error) {
          console.error('Error initializing TrainingLab:', error);
          showErrorMessage(
            'Failed to initialize application. Please refresh the page.'
          );
        }
      }

      // Set up route components
      function setupRouteComponents() {
        // Map page classes to routes
        const pageClasses = {
          '/': DashboardPage,
          '/visualizer': VisualizerPage,
          '/profile': ProfilePage,
          '/library': LibraryPage,
          '/history': HistoryPage,
        };

        // Update routes with component classes
        Object.keys(pageClasses).forEach(path => {
          if (routes[path]) {
            routes[path].component = pageClasses[path];
          }
        });

        // Handle redirects
        if (routes['/dashboard']) {
          routes['/dashboard'].redirect = '/';
        }
        if (routes['/settings']) {
          routes['/settings'].redirect = '/profile';
        }
      }

      // Initialize quick settings
      function initializeQuickSettings() {
        const quickSettingsContainer = document.getElementById(
          'quickSettingsContainer'
        );
        if (quickSettingsContainer) {
          quickSettings = new QuickSettings(quickSettingsContainer);
          window.quickSettings = quickSettings; // Make globally accessible
        }
      }

      // Setup route guards integration
      function setupRouteGuards() {
        if (router && routeGuardManager) {
          // Set up route guard integration
          router.setBeforeRouteChange(async (route, fromRoute) => {
            const guardResult = await routeGuardManager.canActivate(
              route,
              fromRoute
            );

            if (guardResult.result === 'redirect') {
              router.navigate(guardResult.redirectTo);
              return false;
            }

            return guardResult.result === 'allow';
          });

          router.setAfterRouteChange(async (route, fromRoute) => {
            // Handle any post-route change logic
            updatePageTitle(route);
            announcePageChange(route);
          });
        }
      }

      // Update page title
      function updatePageTitle(route) {
        if (route && route.title) {
          document.title = `${route.title} - TrainingLab`;
        }
      }

      // Announce page changes for screen readers
      function announcePageChange(route) {
        const announcements = document.getElementById('sr-announcements');
        if (announcements && route) {
          announcements.textContent = `Navigated to ${route.title || 'page'}`;
        }
      }

      // Show error message
      function showErrorMessage(message) {
        const appContent = document.getElementById('app-content');
        if (appContent) {
          appContent.innerHTML = `
            <div class="error-container" style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              min-height: 50vh;
              text-align: center;
              padding: 2rem;
            ">
              <i class="fas fa-exclamation-triangle" style="
                font-size: 4rem;
                color: #ef4444;
                margin-bottom: 1rem;
              "></i>
              <h2 style="color: #374151; margin-bottom: 0.5rem;">Application Error</h2>
              <p style="color: #6b7280; margin-bottom: 2rem;">${message}</p>
              <button onclick="location.reload()" style="
                background: #3182ce;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
              ">
                Reload Application
              </button>
            </div>
          `;
        }
      }

      // Export for global access
      window.TrainingLab = {
        router: () => router,
        navigation: () => navigation,
        quickSettings: () => quickSettings,
      };

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApplication);
      } else {
        initializeApplication();
      }

      // Handle unhandled promise rejections
      window.addEventListener('unhandledrejection', event => {
        console.error('Unhandled promise rejection:', event.reason);
        // Don't prevent default - let other handlers deal with it
      });
    </script>

    <!-- Additional Styles for App Structure -->
    <style>
      .app-content {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      /* Loading state styles */
      .app-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #3182ce;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </body>
</html>
