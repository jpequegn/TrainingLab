# Pre-push hook for comprehensive quality gates

echo "ğŸš€ Running comprehensive pre-push quality gates..."

# Get current branch
branch=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“‹ Current branch: $branch"

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "âš ï¸  You have uncommitted changes. Please commit or stash them first."
    exit 1
fi

# Security audit (comprehensive)
echo "ğŸ›¡ï¸  Running comprehensive security audit..."
npm audit --audit-level=moderate || {
    echo "âš ï¸  Security vulnerabilities found. Consider running 'npm audit fix'"
    # Continue but warn
}

# Check for outdated dependencies
echo "ğŸ“¦ Checking for outdated dependencies..."
npm outdated || echo "ğŸ’¡ Some dependencies have updates available"

if [ "$branch" = "main" ]; then
    echo "âš ï¸  Pushing to MAIN branch - running FULL validation suite..."
    
    # Comprehensive linting
    echo "ğŸ” Running comprehensive linting (JS/TS/Python)..."
    npm run lint:all || {
        echo "âŒ Comprehensive linting failed"
        exit 1
    }
    
    # Full test suite with coverage
    echo "ğŸ§ª Running full test suite with coverage..."
    npm run test:coverage || {
        echo "âŒ Tests failed"
        exit 1
    }
    
    # Build validation
    echo "ğŸ—ï¸  Running production build..."
    npm run build || {
        echo "âŒ Production build failed"
        exit 1
    }
    
    # E2E tests
    echo "ğŸ­ Running end-to-end tests..."
    npm run test:e2e || {
        echo "âŒ E2E tests failed"
        exit 1
    }
    
    # Quality checks
    echo "ğŸ“Š Running code quality analysis..."
    npm run quality:all || {
        echo "âš ï¸  Code quality issues found, but continuing..."
    }
    
    echo "âœ… ALL pre-push checks PASSED for main branch!"
    echo "ğŸ‰ Ready for production deployment!"
    
elif [ "$branch" = "develop" ]; then
    echo "ğŸ”„ Pushing to DEVELOP branch - running integration checks..."
    
    # Standard linting
    echo "ğŸ” Running linting..."
    npm run lint || {
        echo "âŒ Linting failed"
        exit 1
    }
    
    # Full test suite
    echo "ğŸ§ª Running full test suite..."
    npm run test:run || {
        echo "âŒ Tests failed"
        exit 1
    }
    
    # Build validation
    echo "ğŸ—ï¸  Validating build..."
    npm run build || {
        echo "âŒ Build failed"
        exit 1
    }
    
    # Basic E2E tests
    echo "ğŸ­ Running basic E2E tests..."
    npm run test:e2e || {
        echo "âš ï¸  E2E tests failed, but continuing for develop branch..."
    }
    
    echo "âœ… Pre-push checks passed for develop branch!"
    
else
    echo "ğŸŒ¿ Pushing to FEATURE branch ($branch) - running standard checks..."
    
    # Standard linting
    echo "ğŸ” Running linting..."
    npm run lint || {
        echo "âŒ Linting failed"
        exit 1
    }
    
    # TypeScript checking
    echo "ğŸ” Type checking..."
    npm run type-check || {
        echo "âŒ Type checking failed"
        exit 1
    }
    
    # Unit tests
    echo "ğŸ§ª Running unit tests..."
    npm run test:run || {
        echo "âŒ Unit tests failed"
        exit 1
    }
    
    # Build validation
    echo "ğŸ—ï¸  Validating build..."
    npm run build || {
        echo "âŒ Build failed"
        exit 1
    }
    
    echo "âœ… Pre-push checks passed for feature branch!"
fi

echo "ğŸ¯ Push validation completed successfully!"
echo "ğŸ’¡ Your changes are ready to be pushed to $branch"