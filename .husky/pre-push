# Pre-push hook for comprehensive quality gates

echo "🚀 Running comprehensive pre-push quality gates..."

# Get current branch
branch=$(git rev-parse --abbrev-ref HEAD)
echo "📋 Current branch: $branch"

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "⚠️  You have uncommitted changes. Please commit or stash them first."
    exit 1
fi

# Security audit (comprehensive)
echo "🛡️  Running comprehensive security audit..."
npm audit --audit-level=moderate || {
    echo "⚠️  Security vulnerabilities found. Consider running 'npm audit fix'"
    # Continue but warn
}

# Check for outdated dependencies
echo "📦 Checking for outdated dependencies..."
npm outdated || echo "💡 Some dependencies have updates available"

if [ "$branch" = "main" ]; then
    echo "⚠️  Pushing to MAIN branch - running FULL validation suite..."
    
    # Comprehensive linting
    echo "🔍 Running comprehensive linting (JS/TS/Python)..."
    npm run lint:all || {
        echo "❌ Comprehensive linting failed"
        exit 1
    }
    
    # Full test suite with coverage
    echo "🧪 Running full test suite with coverage..."
    npm run test:coverage || {
        echo "❌ Tests failed"
        exit 1
    }
    
    # Build validation
    echo "🏗️  Running production build..."
    npm run build || {
        echo "❌ Production build failed"
        exit 1
    }
    
    # E2E tests
    echo "🎭 Running end-to-end tests..."
    npm run test:e2e || {
        echo "❌ E2E tests failed"
        exit 1
    }
    
    # Quality checks
    echo "📊 Running code quality analysis..."
    npm run quality:all || {
        echo "⚠️  Code quality issues found, but continuing..."
    }
    
    echo "✅ ALL pre-push checks PASSED for main branch!"
    echo "🎉 Ready for production deployment!"
    
elif [ "$branch" = "develop" ]; then
    echo "🔄 Pushing to DEVELOP branch - running integration checks..."
    
    # Standard linting
    echo "🔍 Running linting..."
    npm run lint || {
        echo "❌ Linting failed"
        exit 1
    }
    
    # Full test suite
    echo "🧪 Running full test suite..."
    npm run test:run || {
        echo "❌ Tests failed"
        exit 1
    }
    
    # Build validation
    echo "🏗️  Validating build..."
    npm run build || {
        echo "❌ Build failed"
        exit 1
    }
    
    # Basic E2E tests
    echo "🎭 Running basic E2E tests..."
    npm run test:e2e || {
        echo "⚠️  E2E tests failed, but continuing for develop branch..."
    }
    
    echo "✅ Pre-push checks passed for develop branch!"
    
else
    echo "🌿 Pushing to FEATURE branch ($branch) - running standard checks..."
    
    # Standard linting
    echo "🔍 Running linting..."
    npm run lint || {
        echo "❌ Linting failed"
        exit 1
    }
    
    # TypeScript checking
    echo "🔍 Type checking..."
    npm run type-check || {
        echo "❌ Type checking failed"
        exit 1
    }
    
    # Unit tests
    echo "🧪 Running unit tests..."
    npm run test:run || {
        echo "❌ Unit tests failed"
        exit 1
    }
    
    # Build validation
    echo "🏗️  Validating build..."
    npm run build || {
        echo "❌ Build failed"
        exit 1
    }
    
    echo "✅ Pre-push checks passed for feature branch!"
fi

echo "🎯 Push validation completed successfully!"
echo "💡 Your changes are ready to be pushed to $branch"